---
layout: post
title: Cart Pole
categories:
- Programming
tags: []
comments: []
---

<br/>
<center>
<img src="/assets/img/2018/05/video.gif"></img>
</center>
<br/>


<p>
	Phil and I have been working on this one for a long time. We finally succeeded in controlling a cart pole. It swings up and balances. Would ya look at that!
</p>

<p>
	The cart pole or inverted pendulum is a classic problem in control theory. It's in <a href="https://gym.openai.com/"> OpenAI Gym</a> of course, but we wanted to see it work in real life, not some <i>lame simulation</i>. We were inspired by <a href="http://underactuated.mit.edu/underactuated.html"> Russ Tedrake's class on underactuated robotics</a> and by the popularity of the problem for reinforcement learning.
</p> 

<!--<p>
	Phil and I have been working on this one for a long time. We've been interested in reinforcement learning but we wanted to see it actually work on a physical system. <a href="https://gym.openai.com/envs/CartPole-v0/">The cart pole system</a> seems to be a popular <i>Hello World</i> for reinforcement learning, so we built one. 
</p> -->

<br/>
<center>
<img src="/assets/img/2018/05/cart_pole.gif"></img>
</center>
<br/>

<h3>A Real-Life Cart Pole</h3>

<p>
	It took a few iterations, but we eventually found a system that works well. Our cart is 3D printed PLA driven by a DC motor via a toothed belt. A rotary encoder opposite the motor acts as a pulley for the belt and allows us to track the motion of the cart, while a second rotary encoder on the cart is a pivot for the pole and measures its angle. The motor is controlled by a 32 amp Sabertooth motor controller. It's overkill, and pretty expensive at about $120, but we already had it for another project. We monitored the encoders with an Arduino. The foundation of the system is a piece of extruded aluminum rail called V-Slot, on which the cart slides and the motor and encoder are mounted. Our rail is 1.5 m long, from a company called <a href="https://www.smw3d.com/">SMW3D</a>. 
</p>

<br/>
<center>
<img src="/assets/img/2018/05/v_slot.png"></img>
</center>
<br/>

<p>
	We used a 3D printer to make a PLA cart with mounting points for a rotary encoder and grooves to lock in a toothed belt.
</p>

<br/>
<center>
<img src="/assets/img/2018/05/cart.png"></img>
</center>
<br/>

<p>
	We found that if you slide the cart onto the V-Slot and dunk the two in boiling water for a moment, you a good fit for sliding with no bearings. A touch of 3-in-1 oil seems to help as well. We also printed some pieces to mount the motor and rotary encoder to the rail.
</p>

<br/>
<center>
<img src="/assets/img/2018/05/mount.png"></img>
</center>
<br/>

<h3>The Software</h3>
<p>
	All the software can be found in <a href="https://github.com/philzook58/cart_pole">this git repositiory</a>. The rotary encoders were monitored by an Arduino Uno. Rotary encoders work by monitoring pulses on two outputs as the shaft rotates. The pulses occur at regular intervals as the shaft turns, and the relative timing of the pulses give the direction of rotation. Normal operation requires two interrupt pins per encoder, but you can get away with one if you're willing to accept halving the resolution. That's what we did because the Uno only has two interrupt pins. We still got 600 positions per revolution of resolution. The microcontroller counts these pulses and keeps track of position by dead reconing. We found that it missed few pulses and worked well. The program sends the current encoder positions whenever it receives a query over serial.
</p>

<p>
	On the other side, a Python program contains all the smarts. It commands the motor controller over serial and can ask the Arduino whenever it needs to know the state of the system. Used two different controllers, one to pump energy into the system and swing the cart into the upright position, and a second to balance it upright. 
</p>

<h3>The LQR Controller</h3>
<p>
	The balancing controller is called an linear quadratic regulator or LQR controller. It is an optimal controller for linear systems with quadratic cost functions. 

	$$\dot{x} = Ax + Bu$$
</p>


<br/>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/wW5EnOloSAU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</center>
<br/>

<h3>What didn't work</h3>
<p>
	
</p>
